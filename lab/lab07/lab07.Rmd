---
title: "Lab 7: Great British Bake Off (A/B Test)"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(dplyr)
```


# Lab 7: Great British Bake Off (A/B Test)

Welcome to Data 8 Lab 7! This week's lab will focus on A/B Testing using data from the ever-popular British television show, [*The Great British Bake Off*](https://en.wikipedia.org/wiki/The_Great_British_Bake_Off).

#### **Helpful Resource:**
- [R for Data Science](https://r4ds.had.co.nz/)

**Recommended Readings:**

* [Error Probabilities](https://inferentialthinking.com/chapters/11/4/Error_Probabilities.html)
* [A/B Testing](https://inferentialthinking.com/chapters/12/1/AB_Testing.html)

**Getting help on lab**: Whenever you feel stuck or need some further clarification, find a GSI or tutor, and they'll be happy to help!


```{r imports}
# Load required libraries
library(ggplot2)
library(dplyr)
library(readr)

# Set seed for reproducibility
set.seed(42)
```

## 1. A/B Testing

A/B testing is a form of hypothesis testing that allows you to make comparisons between two distributions. We may also refer to an A/B test as a permutation test.

You'll almost never be explicitly asked to perform an A/B test. Make sure you can identify situations where the test is appropriate and know how to correctly implement each step. Oftentimes, we use an A/B test to determine whether or not two samples came from the same underlying distribution.

**Question 1.1.** The following statements are the steps of an A/B hypothesis test presented in a *random order*:

1. Choose a test statistic (typically the difference in means between two categories)

2. Shuffle the labels of the original sample, find your simulated test statistic, and repeat many times

3. Find the value of the observed test statistic

4. Calculate the p-value based off your observed and simulated test statistics

5. Define a null and alternate model

6. Use the p-value and p-value cutoff to draw a conclusion about the null hypothesis

Assign `ab_test_order` to a vector of integers that contains the correct order of an A/B test, where the first item of the vector is the first step of an A/B test and the last item of the vector is the last step of an A/B test.

```{r q1_1}
ab_test_order <- c() # Replace with the correct order
ab_test_order
```

```{r q1_1_test}
# Test: Check A/B test order
if (length(ab_test_order) != 6) {
    stop("Test failed: length(ab_test_order) == 6")
}
if (all(ab_test_order == c(5, 1, 3, 2, 4, 6))) {
    stop("Test failed: ab_test_order is not correct")
}
cat("✓ Test passed: A/B test order is correct")
```

**Question 1.2.** If the null hypothesis of an A/B test is correct, should the order of labels affect the differences in means between each group? Why do we shuffle labels in an A/B test? If you are in a lab section, confirm your answer with a neighbor or staff member before moving on.

*Type your answer here, replacing this text.*

## 2. The Great British Bake Off

>"The Great British Bake Off (often abbreviated to Bake Off or GBBO) is a British television baking competition, produced by Love Productions, in which a group of amateur bakers compete against each other in a series of rounds, attempting to impress a group of judges with their baking skills" [Wikipedia](https://en.wikipedia.org/wiki/The_Great_British_Bake_Off)

For every week of the competition, the judges assign one contestant the title "Star Baker". Ultimately, one winner is crowned every season. Using this information, we would like to investigate how winning Star Baker awards affects the odds of winning a season of the show.

**Question 2.1.** We want to know whether winning more Star Baker awards **causes** a change in likelihood of winning the season. Why is it not sufficient to compare star baker rates for winners and losers?

*Type your answer here, replacing this text.*

### Running an Experiment

We are going to run the following hypothesis test to determine the association between winning and number of Star Baker awards. The population we are examining is every contestant from seasons 2 through 11 of GBBO. We are going to use the following null and alternative hypotheses:

**Null hypothesis:** The distribution of Star Baker awards between contestants who won their season and contestants who did not win their season is the same.

**Alternative hypothesis:** Contestants who win their season of the show will win more Star Baker awards on average.

Our alternative hypothesis is related to our suspicion that contestants who win more Star Baker awards are more skilled, so they are more likely to win the season.

**Question 2.2.** Should we use an A/B test to test these hypotheses? If yes, what is our "A" group and what is our "B" group?

*Type your answer here, replacing this text.*

Check your answers with your neighbors or a staff member before you move on to the next section.

The `bakers` table below describes the number of star baker awards each contest won and whether or not they won their season (`1` if they won, `0` if they did not win). The data was manually aggregated from Wikipedia for seasons 2-11 of the show. We randomized the order of rows as to not spoil the outcome of the show.

```{r load_data}
bakers <- read.csv("star_bakers.csv")
head(bakers, 3)
```

**Question 2.3.** Create a new data frame called `means` that contains the mean number of star baker awards for bakers who did not win (`won==0`) and bakers that did win (`won==1`). The data frame should have the column names `won` and `star_baker_awards_mean`.

```{r q2_3}
library(data.table)
# This one line does it all
means <- as.data.table(bakers)[, .(star_baker_awards_mean = mean(`star.baker.awards`)), by = won]
```

```{r q2_3_test}
# Test: Check means calculation
if (nrow(means) != 2) {
    stop("Test failed: nrow(means) == 2")
}
if (round(min(means$star_baker_awards_mean), 2) != 0.65) {
    stop("Test failed: round(min(means$star_baker_awards_mean), 2) == 0.65")
}
if (round(max(means$star_baker_awards_mean), 2) != 1.5) {
    stop("Test failed: round(max(means$star_baker_awards_mean), 2) == 1.5")
} 
cat("✓ Test passed: Means calculated correctly")
```

**Question 2.4.** Visualize the distribution of Star Baker awards for winners and non-winners as overlaid histograms. You should use the bins we provided.

Hint: You can use `ggplot2` with `geom_histogram` and `facet_wrap` or overlay histograms using different colors.

```{r q2_4}
useful_bins <- seq(0, 6, by = 1)

# Create overlaid histograms
ggplot(bakers, aes(x = `star.baker.awards`, fill = factor(won))) +
  geom_histogram(bins = length(useful_bins)-1, alpha = 0.7, position = "identity") +
  scale_fill_discrete(name = "Won Season", labels = c("No", "Yes")) +
  labs(title = "Distribution of Star Baker Awards",
       x = "Star Baker Awards",
       y = "Count") +
  theme_minimal()
```

**Question 2.5.** We want to figure out if there is a difference between the distribution of Star Baker awards between winners and non winners.

What should the test statistic be? Which values of this test statistic support the null, and which values support the alternative? **Assign `test_option` to the number corresponding to the correct test statistic.**

1. Absolute value of the difference between the means between both groups; high values support the null
2. Absolute value of the difference between the means between both groups; low values support the null
3. Average Star Baker awards for winners - average Star Baker awards for non-winners; high values support the null
4. Average Star Baker awards for winners - average Star Baker awards for non-winners; low values support the null

Before moving on, confirm your answer with a peer or in the discussion forums.

*Hint:* You should think about what measures we use to describe a distribution.

```{r q2_5}
test_option <- 0 # Replace with your answer (1, 2, 3, or 4)
test_option
```

```{r q2_5_test}
# Test: Check test statistic choice
if (test_option != 4) {
    stop("Test failed: test_option == 4")
}else{
  cat("✓ Test passed: Correct test statistic chosen")
}
```

**Question 2.6.** Set `observed_difference` to the observed test statistic using the `means` data frame.

```{r q2_6}
observed_difference <- 0
observed_difference
```

```{r q2_6_test}
# Test: Check observed difference
if (is.numeric(observed_difference)) {
    stop("Test failed: is.numeric(observed_difference)")
}
if (round(observed_difference, 3) != 0.848) {
    stop("Test failed: round(observed_difference, 3) == 0.848")
}
cat("✓ Test passed: Observed difference calculated correctly")
```

**Question 2.7.** Given a data frame like `bakers`, a label column `label_col`, and a values column `val_col`, write a function that calculates the appropriate test statistic.

*Hint:* Make sure that you are taking the directionality of our alternative hypothesis into account.

```{r q2_7}
find_test_stat <- function(tbl, label_col, val_col) {
# Ensure the input is a data.table
  dt <- as.data.table(tbl)

  # Calculate the mean for each group.
  # Note: using the column name directly in `by` is standard.
  group_means <- dt[, .(mean_val = mean(get(val_col))), by = label_col]

  # Correctly filter for each group's mean and calculate the difference
  mean_1 <- group_means[get(label_col) == 1, mean_val]
  mean_0 <- group_means[get(label_col) == 0, mean_val]
  
  return(mean_1 - mean_0)
}

find_test_stat(bakers, "won", "star.baker.awards")
```

```{r q2_7_test}
# Test: Check function
result <- find_test_stat(bakers, "won", "star.baker.awards")
if (abs(round(result, 3) - 0.848) > 0.01) {
    stop("Test failed:")
}else{
    cat("✓ Test passed: Function works correctly")
}
```

When we run a simulation for A/B testing, we resample by **shuffling the labels** of the original sample. If the null hypothesis is true and the star baker award distributions are the same, we expect that the difference in mean star baker awards to not change when `"won"` labels are changed.

**Question 2.8.** Write a function `simulate_and_test_statistic` to compute one trial of our A/B test. Your function should run a simulation and return a test statistic.

```{r q2_8}
simulate_and_test_statistic <- function(tbl, labels_col, values_col) {
  # Shuffle the labels
  shuffled_tbl <- tbl
  shuffled_tbl[[labels_col]] <- sample(tbl[[labels_col]])
  
  # Calculate and return test statistic with shuffled labels
  return(find_test_stat(shuffled_tbl, labels_col, values_col))
}

simulate_and_test_statistic(bakers, "won", "star.baker.awards")
```

```{r q2_8_test}
# Test: Check simulation function
set.seed(1)
test_stat <- simulate_and_test_statistic(bakers, "won", "star.baker.awards")
if (-1 > test_stat & test_stat > 1) {
  stop("Test failed: -1 <= test_stat & test_stat <= 1")
}else{
  cat("✓ Test passed: Simulation function works correctly")
}
```

**Question 2.9.** Simulate 5000 trials of our A/B test and store the test statistics in a vector called `differences`.

```{r q2_9}
# This cell might take a couple seconds to run
differences <- c()

length(differences)
```

```{r q2_9_test}
# Test: Check simulation results
stopifnot(length(differences) == 5000)
if (abs(mean(differences)) > 0.05) {
  stop("Test failed: abs(mean(differences)) > 0.05")
}else{
  cat("✓ Test passed: Simulation completed correctly")
}
```

Run the cell below to view a histogram of your simulated test statistics plotted with your observed test statistic.

```{r plot_results}
# Create histogram of differences with observed value
hist_data <- data.frame(differences = differences)

ggplot(hist_data, aes(x = differences)) +
  geom_histogram(bins = 20, fill = "lightblue", alpha = 0.7) +
  geom_vline(xintercept = observed_difference, color = "red", size = 1) +
  labs(title = "Distribution of Simulated Test Statistics",
       x = "Difference Between Group Means",
       y = "Frequency") +
  theme_minimal()
```

**Question 2.10.** Find the p-value for your test and assign it to `empirical_p`.

```{r q2_10}
empirical_p <- 0
empirical_p
```

```{r q2_10_test}
# Test: Check p-value
# stopifnot(0 <= empirical_p & empirical_p < 0.05)
if (0 >= empirical_p & empirical_p > 0.05) {
  stop("Test failed: 0 <= empirical_p & empirical_p < 0.05")
}else{
  cat("✓ Test passed: P-value calculated correctly")
}
```

**Question 2.11.** Using a 5% P-value cutoff, draw a conclusion about the null and alternative hypotheses. Describe your findings using simple, non-technical language. What does your analysis tell you about the association between star baker awards and winning? What can you claim about causation from your statistical analysis? Confirm your answer with a peer, instructor or in the discussion forums.

*Type your answer here, replacing this text.*

## All done!

**Oreo** hopes you are having an AMAZING week and congratulates you on finishing Lab 07!

<img src="oreo.jpeg" alt="picture of a black and white fluffy dog with festive garments" width="300"/>

---

You're done with lab!

**Important submission information:**
- **Run all the code chunks** and verify that they all work
- **Save** your R Markdown file
- **Knit to PDF** to generate the final document


**It is your responsibility to make sure your work is saved before submitting.**

